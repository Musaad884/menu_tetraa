<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>منيو تترا بيتزا</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
      color: #333;
      overflow-x: hidden;
    }
    header {
      background: #4a4a4a;
      padding: 1rem;
      text-align: center;
      font-size: 1.8rem;
      font-weight: bold;
      color: #fff;
      position: relative;
    }
    .checkout-global {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #2a2a2a;
      text-align: center;
      padding: 0.5rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .checkout-global button {
      background: #ff5722;
      color: #fff;
      padding: 0.8rem 1.2rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    .checkout-global button:hover {
      background: #e64a19;
    }
    .category-tabs {
      position: sticky;
      top: 70px; /* Adjust this value if the checkout bar height changes */
      z-index: 9;
      background-color: #fff;
      padding: 0.75rem 0.5rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: flex-start;
      gap: 0.5rem;
      overflow-x: auto;
      white-space: nowrap;
      -webkit-overflow-scrolling: touch;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .category-tabs::-webkit-scrollbar {
      display: none;
    }
    .category-tabs button {
      background-color: #f0f0f0;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: #555;
      transition: background-color 0.2s ease, transform 0.2s ease;
      flex-shrink: 0;
    }
    .category-tabs button.active {
      background-color: #2196F3;
      color: #fff;
      font-weight: bold;
      transform: scale(1.05);
    }
    .menu {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1.5rem;
      padding: 1.5rem;
    }
    .item {
      background: #fff;
      border-radius: 12px;
      padding: 1.2rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .item:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
    }
    .item img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 0.75rem;
    }
    .item h3 {
      font-size: 1.2rem;
      margin: 0.5rem 0 0.25rem;
      font-weight: 600;
    }
    .item p {
      font-size: 0.9rem;
      margin: 0.2rem 0;
      color: #666;
    }
    .item .price {
      font-size: 1.1rem;
      font-weight: bold;
      color: #e64a19;
      margin-top: auto;
    }
    .item .actions {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .item .size-buttons {
      display: flex;
      justify-content: space-around;
      gap: 0.5rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }
    .item .size-buttons button {
      flex: 1 1 80px;
      padding: 0.6rem;
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ddd;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    .item .size-buttons button:hover {
      background: #e0e0e0;
      border-color: #bbb;
    }
    .item button {
      padding: 0.8rem 1rem;
      background: #2196F3;
      color: #fff;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: background 0.3s ease;
    }
    .item button:hover {
      background: #1976D2;
    }
    .item .qty-btn {
      background: #2196F3;
      padding: 0.6rem 1rem;
      font-size: 1.2rem;
      font-weight: bold;
    }
    .cart {
      position: fixed;
      top: 0;
      right: -450px;
      width: 400px;
      max-width: 90%;
      height: 100%;
      background: #fff;
      box-shadow: -4px 0 10px rgba(0,0,0,0.1);
      padding: 1.5rem;
      transition: right 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
      display: flex;
      flex-direction: column;
      z-index: 100;
    }
    .cart.open {
      right: 0;
    }
    .cart h2 {
      margin-top: 0;
      font-size: 1.5rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    .cart-items {
      flex: 1;
      overflow-y: auto;
      padding: 0.5rem 0;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding: 0.75rem;
      background: #f9f9f9;
      border-radius: 8px;
    }
    .cart-item span {
      flex: 1;
    }
    .cart-item button {
      background: #f44336;
      border: none;
      color: #fff;
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    .cart-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #ff5722;
      color: #fff;
      width: 55px;
      height: 55px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
      font-size: 1.8rem;
      z-index: 50;
    }
  </style>
</head>
<body>
  <header>منيو تترا بيتزا</header>
  
  <div class="checkout-global">
    <button onclick="checkout()">إرسال الطلب</button>
  </div>

  <div class="category-tabs" id="category-tabs"></div>

  <div class="menu" id="menu"></div>

  <div class="cart" id="cart">
    <h2>السلة</h2>
    <div class="checkout-global">
      <button onclick="checkout()">إرسال الطلب</button>
    </div>
    <div class="cart-items" id="cart-items"></div>
  </div>
  <div class="cart-toggle" onclick="toggleCart()">🛒</div>
  
  <script>
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) { try { tg.ready(); tg.expand(); } catch(_){} }

    const menuData = [
      // عروض (Offers)
      { id: 1, category: 'عروض', name: 'عرض الأوسط', description: '', price: 65, image: '36.jpg' },
      { id: 2, category: 'عروض', name: 'عرض الكبير', description: '', price: 99, image: '37.jpg' },
      { id: 3, category: 'عروض', name: 'عرض العائلي', description: '', price: 139, image: '38.jpg' },
      // باستا (Pasta)
      { id: 4, category: 'باستا', name: 'بيستو باستا', description: '', price: 30, image: 'bestobasta.jpg' },
      { id: 5, category: 'باستا', name: 'فيتوتشيني باستا', description: '', price: 25, image: 'fotytshenebasta.jpg' },
      { id: 6, category: 'باستا', name: 'لازانيا', description: '', price: 27, image: 'lazanya.jpg' },
      { id: 7, category: 'باستا', name: 'ميكسكان بنا', description: '', price: 25, image: 'maxicanbana.jpg' },
      // جوانب (Sides)
      { id: 8, category: 'جوانب', name: 'بطاطس بالجبنة', description: '', price: 15, image: 'chessfrise.jpg' },
      { id: 9, category: 'جوانب', name: 'بطاطس ويدجز', description: '', price: 10, image: 'wedges.jpg' },
      { id: 10, category: 'جوانب', name: 'واو فرايز دجاج', description: '', price: 26, image: 'wowfrise.jpg' },
      { id: 11, category: 'جوانب', name: 'واو فرايز جمبري', description: '', price: 30, image: 'wowfrise.jpg' },
      { id: 12, category: 'جوانب', name: 'حلقات بصل', description: '', price: 10, image: 'circleonion.jpg' },
      { id: 13, category: 'جوانب', name: 'كيرلي فرايز', description: '', price: 9, image: 'kerle.jpg' },
      { id: 14, category: 'جوانب', name: 'بطاطس', description: '', price: 8, image: 'frise.jpg' },
      { id: 15, category: 'جوانب', name: 'سلطة سيزر', description: '', price: 14, image: 'salath.jpg' },
      { id: 16, category: 'جوانب', name: 'سلطة خضراء', description: '', price: 12, image: 'salath.jpg' },
      { id: 17, category: 'جوانب', name: 'أصابع موزاريلا', description: '', price: 13, image: 'mozorela.jpg' },
      { id: 18, category: 'جوانب', name: '4 أجنحة دجاج', description: '', price: 14, image: 'ckicenwings.jpg' },
      { id: 19, category: 'جوانب', name: '8 أجنحة دجاج', description: '', price: 27, image: 'ckicenwings.jpg' },
      { id: 20, category: 'جوانب', name: 'كوكيز', description: '', price: 6, image: 'cokies.jpg' },
      // دجاج TCB
      { id: 21, category: 'دجاج TCB', name: 'صدور دجاج تي سي بي دايناميت جبن', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbdenametchees.jpg' },
      { id: 22, category: 'دجاج TCB', name: 'أصابع دجاج تي سي بي دايناميت جبن', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbdenametchees.jpg' },
      { id: 23, category: 'دجاج TCB', name: 'دايناميت تي سي بي صدور دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbdenamet.jpg' },
      { id: 24, category: 'دجاج TCB', name: 'دايناميت تي سي بي أصابع دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbdenamet.jpg' },
      { id: 25, category: 'دجاج TCB', name: 'فرنسي تي سي بي صدور دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbfreanch.jpg' },
      { id: 26, category: 'دجاج TCB', name: 'فرنسي تي سي بي أصابع دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbfreanch.jpg' },
      { id: 27, category: 'دجاج TCB', name: 'رانش تي سي بي أصابع دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbranch.jpg' },
      { id: 28, category: 'دجاج TCB', name: 'رانش تي سي بي صدور دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbranch.jpg' },
      { id: 29, category: 'دجاج TCB', name: 'تي سي بي باربكيو صدور دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbbbq.jpg' },
      { id: 30, category: 'دجاج TCB', name: 'تي سي بي باربكيو أصابع دجاج', description: '', sizes: [{name: 'عادي', price: 16}, {name: 'دبل', price: 22}], image: 'tcbbbq.jpg' },
      // بيتزا (Pizza)
      { id: 31, category: 'بيتزا', name: 'سموكي', description: 'دجاج مشوي + صلصة سموكي + فلفل اخضر + فلفل اصفر + جبنة تترا', sizes: [{name: 'S', price: 23}, {name: 'M', price: 35}, {name: 'L', price: 41}], image: 'smokepizza.png' },
      { id: 32, category: 'بيتزا', name: 'تكا بيتزا', description: 'دجاج التكا المشوي + صوص التكا + الفلفل الأخضر + البصل + جبنة تترا', sizes: [{name: 'S', price: 21}, {name: 'M', price: 33}, {name: 'L', price: 43}], image: 'takapezz.jpg' },
      { id: 33, category: 'بيتزا', name: 'بيري بيري', description: 'دجاج تترا المشوي + صوص البري بيري الحار + بصل + فلفل احمر + جبنة تترا', sizes: [{name: 'S', price: 21}, {name: 'M', price: 33}, {name: 'L', price: 43}], image: 'berebere.jpg' },
      { id: 34, category: 'بيتزا', name: 'رانش فاير', description: 'دجاج الرانش + صلصة الرانش الحارة + جبنة تترا', sizes: [{name: 'S', price: 21}, {name: 'M', price: 33}, {name: 'L', price: 43}], image: 'ranchfire.jpg' },
      { id: 35, category: 'بيتزا', name: 'ميكسيكان سبايسي', description: 'دجاج تترا المشوي + صلصة تترا الحارة + فلفل اخضر + هلابينو + بصل + جبنة تترا + طماطم', sizes: [{name: 'S', price: 18}, {name: 'M', price: 30}, {name: 'L', price: 40}], image: 'maxicanspyce.jpg' },
      { id: 36, category: 'بيتزا', name: 'فاهيتا دجاج', description: 'دجاج فاهيتا + صلصة تترا الخاصة + فلفل اخضر + مشروم + بصل + جبنة تترا', sizes: [{name: 'S', price: 18}, {name: 'M', price: 30}, {name: 'L', price: 40}], image: 'faheta.jpg' },
      { id: 37, category: 'بيتزا', name: 'شاورما', description: 'صلصة شاورما + جبنة تترا + دجاج شاورما تترا + فلفل احمر + مخلل', sizes: [{name: 'S', price: 19}, {name: 'M', price: 31}, {name: 'L', price: 41}], image: 'shawerma.jpg' },
      { id: 38, category: 'بيتزا', name: 'رانش تشيكن', description: 'دجاج الرانش + صلصة الرانش + جبنة تترا', sizes: [{name: 'S', price: 20}, {name: 'M', price: 31}, {name: 'L', price: 41}], image: 'ranchchecken.jpg' },
      { id: 39, category: 'بيتزا', name: 'تترا كوين', description: 'قطع دجاج + صلصة تترا الخاصة + جبنة تترا', sizes: [{name: 'S', price: 21}, {name: 'M', price: 32}, {name: 'L', price: 43}], image: 'tetraqueen.jpg' },
      { id: 40, category: 'بيتزا', name: 'اكسترا سوبريم', description: 'صلصة تترا + جبنة تترا + زيتون اسود + فلفل اخضر + مشروم + قطع لحم + بصل + ببروني', sizes: [{name: 'S', price: 21}, {name: 'M', price: 31}, {name: 'L', price: 41}], image: 'exstrasuperreem.jpg' },
      { id: 41, category: 'بيتزا', name: 'فرنش بيتزا', description: 'دجاج مشوي + صلصة فرانسية خاصة + فلفل احمر + بصل + زيتون اسود + مشروم + جبنة تترا', sizes: [{name: 'S', price: 19}, {name: 'M', price: 31}, {name: 'L', price: 41}], image: 'freanch.jpg' },
      { id: 42, category: 'بيتزا', name: 'خضار', description: 'صلصة تترا + فلفل اخضر + فلفل اصفر + بصل + زيتون اسود + مشروم + طماطم + جبنة تترا', sizes: [{name: 'S', price: 16}, {name: 'M', price: 28}, {name: 'L', price: 28}], image: 'vegtabols.jpg' },
      { id: 43, category: 'بيتزا', name: 'باربكيو دجاج', description: 'دجاج مشوي + صلصة الباربكيو + فلفل اخضر + فلفل اصفر + بصل + مشروم + جبنة تترا', sizes: [{name: 'S', price: 18}, {name: 'M', price: 30}, {name: 'L', price: 40}], image: 'bbq.jpg' },
      { id: 44, category: 'بيتزا', name: 'مارغريتا', description: 'مكس اجبان تترا + صلصة تترا الخاصة', sizes: [{name: 'S', price: 16}, {name: 'M', price: 28}, {name: 'L', price: 38}], image: 'margareta.jpg' },
      { id: 45, category: 'بيتزا', name: 'داينمايت دجاج', description: 'ديناميت صوص + جبنة تترا + دجاج', sizes: [{name: 'S', price: 19}, {name: 'M', price: 29}, {name: 'L', price: 39}], image: 'dynamitt.jpg' },
      { id: 46, category: 'بيتزا', name: 'داينمايت جمبري', description: 'ديناميت صوص + جبنة تترا + جمبري', sizes: [{name: 'S', price: 23}, {name: 'M', price: 35}, {name: 'L', price: 45}], image: 'dynamitt.jpg' },
      { id: 47, category: 'بيتزا', name: 'بيبروني', description: 'صلصة تترا + ببروني + جبنة تترا', sizes: [{name: 'S', price: 19}, {name: 'M', price: 31}, {name: 'L', price: 41}], image: 'babrone.jpg' },
      // صوصات (Sauces)
      { id: 48, category: 'صوصات', name: 'صوص داينمايت', description: '', price: 2, image: 'suse4.png' },
      { id: 49, category: 'صوصات', name: 'صوص جبنة', description: '', price: 4, image: 'suse2.png' },
      { id: 50, category: 'صوصات', name: 'صوص فرنش', description: '', price: 2, image: 'suse3.png' },
      { id: 51, category: 'صوصات', name: 'صوص رانش', description: '', price: 2, image: 'suse1.png' },
      { id: 52, category: 'صوصات', name: 'صوص ثوم', description: '', price: 2, image: 'suse1.png' },
      // وجبة أطفال (Kids Meal)
      { id: 53, category: 'وجبة أطفال', name: 'وجبة أطفال جبن', description: '', price: 15, image: 'happymeal.jpg' },
      { id: 54, category: 'وجبة أطفال', name: 'وجبة أطفال خضار', description: '', price: 15, image: 'happymeal.jpg' },
      { id: 55, category: 'وجبة أطفال', name: 'وجبة أطفال ببروني', description: '', price: 15, image: 'happymeal.jpg' },
      // مشروبات (Drinks)
      { id: 56, category: 'مشروبات', name: 'ماء', description: '', price: 2, image: 'water.jpg' },
      { id: 57, category: 'مشروبات', name: 'كولا', description: '1 لتر', price: 8, image: 'colaleter.jpg' },
      { id: 58, category: 'مشروبات', name: 'كولا', description: '2.25 لتر', price: 12, image: 'colafamily.jpg' },
      { id: 59, category: 'مشروبات', name: 'كولا', description: 'علبة', price: 4, image: 'cola.jpg' },
      { id: 60, category: 'مشروبات', name: 'سيزر', description: 'علبة', price: 4, image: 'ceaser.jpg' },
      { id: 61, category: 'مشروبات', name: 'ربيع', description: 'علبة', price: 3, image: 'rabea.jpg' }
    ];

    const menuContainer = document.getElementById("menu");
    const cartContainer = document.getElementById("cart-items");
    const tabsContainer = document.getElementById("category-tabs");
    let cart = [];
    let checkoutStep = 0;
    let currentCategory = 'جميع الأصناف'; // Default to show all

    function getUniqueCategories() {
        const categories = [...new Set(menuData.map(item => item.category))];
        return ['جميع الأصناف', ...categories];
    }

    function renderTabs() {
        const categories = getUniqueCategories();
        tabsContainer.innerHTML = '';
        categories.forEach(category => {
            const button = document.createElement("button");
            button.innerText = category;
            button.className = (category === currentCategory) ? 'active' : '';
            button.onclick = () => filterMenu(category);
            tabsContainer.appendChild(button);
        });
    }

    function filterMenu(category) {
        currentCategory = category;
        renderTabs();
        renderMenu();
    }

    function renderMenu() {
        menuContainer.innerHTML = "";
        let filteredItems = menuData;
        if (currentCategory !== 'جميع الأصناف') {
            filteredItems = menuData.filter(item => item.category === currentCategory);
        }

        filteredItems.forEach(item => {
            const div = document.createElement("div");
            div.className = "item";
            const isSizeBased = item.sizes !== undefined;
            
            let actionsHTML = '';
            if (isSizeBased) {
              actionsHTML = `<div class="size-buttons">`;
              item.sizes.forEach(size => {
                const cartItemId = `${item.id}-${size.name}`;
                const inCart = cart.find(c => c.id === cartItemId);
                if (inCart) {
                  actionsHTML += `
                    <div style="display: flex; align-items: center; gap: 0.25rem;">
                        <button class="qty-btn" onclick="changeQty('${cartItemId}', -1)">-</button>
                        <span>${inCart.qty}</span>
                        <button class="qty-btn" onclick="changeQty('${cartItemId}', 1)">+</button>
                    </div>
                  `;
                } else {
                  actionsHTML += `<button onclick="addWithSize(${item.id}, '${size.name}', ${size.price})">${size.name} (${size.price} ريال)</button>`;
                }
              });
              actionsHTML += `</div>`;
            } else {
              const inCart = cart.find(c => c.id === item.id);
              if (inCart) {
                actionsHTML = `
                  <button class="qty-btn" onclick="changeQty(${item.id}, -1)">-</button>
                  <span>${inCart.qty}</span>
                  <button class="qty-btn" onclick="changeQty(${item.id}, 1)">+</button>
                `;
              } else {
                actionsHTML = `<button onclick="addToCart(${item.id})">أضف للسلة</button>`;
              }
            }
            
            div.innerHTML = `
              <img src="${item.image || 'https://via.placeholder.com/300x150'}" alt="${item.name}" />
              <h3>${item.name}</h3>
              <p>${item.description}</p>
              ${!isSizeBased ? `<p class="price">${item.price} ريال</p>` : ''}
              <div class="actions">
                ${actionsHTML}
              </div>
            `;
            menuContainer.appendChild(div);
        });
    }

    function addWithSize(id, sizeName, price) {
        const item = menuData.find(m => m.id === id);
        
        const cartItemId = `${id}-${sizeName}`;
        const found = cart.find(c => c.id === cartItemId);
        
        if (found) {
            found.qty++;
        } else {
            cart.push({
                id: cartItemId,
                name: `${item.name} (${sizeName})`,
                baseId: id,
                price: price,
                qty: 1
            });
        }
        renderCart();
        renderMenu();
    }

    function addToCart(id){
      const item = menuData.find(m => m.id === id);
      if (!item) return;
      const found = cart.find(c => c.id === id);
      if(found){
        found.qty++;
      } else {
        cart.push({...item, qty:1});
      }
      renderCart();
      renderMenu();
    }

    function changeQty(id, delta){
      const found = cart.find(c => c.id == id);
      if(found){
        found.qty += delta;
        if(found.qty <= 0){
          cart = cart.filter(c => c.id != id);
        }
      }
      renderMenu();
      renderCart();
    }

    function removeFromCart(id){
      cart = cart.filter(c => c.id != id);
      renderMenu();
      renderCart();
    }

    function renderCart(){
      cartContainer.innerHTML = '';
      let total = 0;
      cart.forEach(c => {
        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <span>${c.name} x${c.qty} (${c.price} ريال)</span>
          <button onclick="removeFromCart('${c.id}')">حذف</button>
        `;
        cartContainer.appendChild(div);
        total += c.price * c.qty;
      });

      const totalDiv = document.createElement("div");
      totalDiv.style.marginTop = "1rem";
      totalDiv.style.fontWeight = "bold";
      totalDiv.innerText = "الإجمالي: " + total + " ريال";
      cartContainer.appendChild(totalDiv);

      renderMenu();
    }

    function toggleCart(){
      document.getElementById("cart").classList.toggle("open");
    }
    
    if (tg) {
      tg.onEvent('mainButtonClicked', () => {
        if (document.getElementById("cart").classList.contains("open")) {
          toggleCart();
        }
      });
    }

    function getChatId() {
      const fromTG = window.Telegram?.WebApp?.initDataUnsafe?.user?.id ?? null;
      if (fromTG) return Number(fromTG);
      const params = new URLSearchParams(location.search);
      const fromURL = params.get('chat_id');
      return fromURL ? Number(fromURL) : null;
    }

    function sanitizeCartItems(items) {
      return items.map(i => {
        const priceNum = Number(i.price || 0);
        const qtyNum = Number(i.qty || 0);
        return { name: i.name, price: priceNum, qty: qtyNum };
      });
    }

    async function checkout(){
      if(cart.length === 0){
        alert("السلة فارغة!");
        return;
      }

      if(checkoutStep === 0){
        toggleCart();
        checkoutStep = 1;
        return;
      }

      if(!window.Telegram?.WebApp){
        alert("⚠️ افتح المنيو من داخل تيليجرام عبر زر البوت.");
        return;
      }

      const chat_id = getChatId();
      const cleanItems = sanitizeCartItems(cart);
      const total = cleanItems.reduce((s,c) => s + (c.price * c.qty), 0);

      const payload = {
        items: cleanItems,
        total,
        time: new Date().toISOString(),
        chat_id,
        source: "webapp"
      };

      try {
        const res = await fetch("https://saif918.app.n8n.cloud/webhook/cart_submit", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify(payload)
        });

        if(res.ok){
          alert("تم إرسال الطلب بنجاح! ✅");
          try { window.Telegram.WebApp.close(); } catch(_) {}
          cart = [];
          renderMenu();
          renderCart();
          checkoutStep = 0;
        } else {
          const t = await res.text();
          alert("⚠️ فشل الإرسال\n" + t);
        }
      } catch (err) {
        alert("❌ Load failed: خطأ في الاتصال");
      }
    }

    renderTabs();
    renderMenu();
  </script>
</body>
</html>
